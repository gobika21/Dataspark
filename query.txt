-- Overall Sales Performance (Trends & Seasonality)
SELECT 
    DATE_FORMAT(A2_DataSpark.SalesTable.order_date, '%Y-%m') AS order_year_month,
    COUNT(*) AS total_orders
    -- sum(A2_DataSpark.ProductTable.unit_price_usd) as price
FROM 
    A2_DataSpark.SalesTable
join A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
GROUP BY 
    DATE_FORMAT(A2_DataSpark.SalesTable.order_date, '%Y-%m')
ORDER BY 
    order_year_month;

-- Sales by Product (Top Performers) 
SELECT 
	A2_DataSpark.ProductTable.product_name,
    -- A2_DataSpark.SalesTable.productkey,
    SUM(A2_DataSpark.SalesTable.quantity) AS quantity, 
    sum(A2_DataSpark.ProductTable.unit_price_usd * A2_DataSpark.SalesTable.quantity) as price
FROM 
    A2_DataSpark.SalesTable
join A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
GROUP BY 
    A2_DataSpark.SalesTable.productkey
ORDER BY 
    price DESC
LIMIT 10;

-- Sales by Store (Store Performance)

SELECT 
    A2_DataSpark.SalesTable.storekey, 
    sum(A2_DataSpark.ProductTable.unit_price_usd) as price,
    COUNT(*) AS total_orders
FROM 
    A2_DataSpark.SalesTable
join A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
GROUP BY 
    A2_DataSpark.SalesTable.storekey
ORDER BY 
    price DESC;
    
-- Sales by Currency (Considering Exchange Rates) 
SELECT 
    A2_DataSpark.SalesTable.currency_code as currency, 
    SUM(A2_DataSpark.ProductTable.unit_price_usd * A2_DataSpark.ExchangeRateTable.exchange) as total_sales_in_base_currency,
    COUNT(*) as total_orders
FROM 
    A2_DataSpark.SalesTable
JOIN A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
JOIN A2_DataSpark.ExchangeRateTable on A2_DataSpark.SalesTable.currency_code = A2_DataSpark.ExchangeRateTable.currency
GROUP BY 
    currency
ORDER BY 
    total_sales_in_base_currency DESC;
    

-- Most Popular Products
SELECT 
	A2_DataSpark.ProductTable.product_name,
    sum(A2_DataSpark.ProductTable.unit_price_usd * A2_DataSpark.SalesTable.quantity) as price
FROM 
    A2_DataSpark.SalesTable
join A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
GROUP BY 
    A2_DataSpark.SalesTable.productkey
ORDER BY 
    price DESC
LIMIT 10;

-- Least Popular Products
SELECT 
	A2_DataSpark.ProductTable.product_name,
    sum(A2_DataSpark.ProductTable.unit_price_usd * A2_DataSpark.SalesTable.quantity) as price
FROM 
    A2_DataSpark.SalesTable
join A2_DataSpark.ProductTable on A2_DataSpark.SalesTable.productkey = A2_DataSpark.ProductTable.productkey
GROUP BY 
    A2_DataSpark.SalesTable.productkey
ORDER BY 
    price ASC
LIMIT 10;


-- Profitability Analysis (Profit Margins)
SELECT 
    A2_DataSpark.ProductTable.productkey, 
    AVG(A2_DataSpark.ProductTable.unit_price_usd) AS avg_unit_price, 
    AVG(A2_DataSpark.ProductTable.unit_cost_usd) AS avg_unit_cost, 
    (AVG(A2_DataSpark.ProductTable.unit_price_usd) - AVG(A2_DataSpark.ProductTable.unit_cost_usd)) AS profit_per_unit, 
    ((AVG(A2_DataSpark.ProductTable.unit_price_usd) - AVG(A2_DataSpark.ProductTable.unit_cost_usd)) / AVG(A2_DataSpark.ProductTable.unit_price_usd)) * 100 AS profit_margin_percentage
FROM 
    A2_DataSpark.ProductTable
GROUP BY 
    A2_DataSpark.ProductTable.productkey
ORDER BY 
    profit_margin_percentage DESC;
    
    
-- Category Analysis
Select 
	A2_DataSpark.ProductTable.categorykey, A2_DataSpark.ProductTable.subcategorykey,
    sum(A2_DataSpark.SalesTable.quantity) as quantity,
    sum(A2_DataSpark.ProductTable.unit_price_usd * A2_DataSpark.SalesTable.quantity) as price
from 
A2_DataSpark.ProductTable
join A2_DataSpark.SalesTable on A2_DataSpark.ProductTable.productkey = A2_DataSpark.SalesTable.productkey
group by
A2_DataSpark.ProductTable.categorykey, A2_DataSpark.ProductTable.subcategorykey
order by
A2_DataSpark.ProductTable.categorykey, A2_DataSpark.ProductTable.subcategorykey